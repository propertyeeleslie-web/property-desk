<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Property Desk</title>
<style>
body{font-family:Arial;background:#f3f4f6;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;max-width:1000px;margin:auto}
input,select,button{padding:8px;margin:5px;width:100%}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border-bottom:1px solid #ddd;padding:8px}
.green{background:#bbf7d0}
.red{background:#fca5a5}
.yellow{background:#fde68a}
.admin-only{display:none}
</style>
</head>
<body>

<div class="card" id="login">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<div id="err"></div>
</div>

<div class="card" id="app" style="display:none">
<h2>Properties</h2>

<div class="admin-only">
<h3>Add / Edit Property</h3>
<input id="pid" type="hidden">
<input id="project" placeholder="Project">
<input id="unit" placeholder="Unit">
<select id="status">
<option>Vacant</option>
<option>Rented</option>
</select>
<input id="rent" placeholder="Asking Rent">
<input id="owner" placeholder="Owner Name">
<input id="phone" placeholder="Owner Phone">
<input id="notes" placeholder="Notes">
<button onclick="save()">Save</button>
</div>

<table>
<thead>
<tr>
<th>Project</th>
<th>Unit</th>
<th>Status</th>
<th>Rent</th>
<th class="admin-only">Owner</th>
<th class="admin-only">Phone</th>
<th>Notes</th>
<th class="admin-only">Edit</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<script>
let token="", role="";

async function login(){
  const res = await fetch("/api/login",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      email:email.value.trim(),
      password:password.value
    })
  });
  const data = await res.json();
  if(!res.ok){ err.innerText=data.error; return; }
  token=data.token; role=data.role;
  login.style.display="none";
  app.style.display="block";
  if(role==="ADMIN"){
    document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block");
  }
  load();
}

async function load(){
  const res = await fetch("/api/properties",{
    headers:{Authorization:"Bearer "+token}
  });
  const data = await res.json();
  list.innerHTML="";
  data.properties.forEach(p=>{
    let cls="green";
    if(p.status==="Rented") cls="red";
    if(p.status==="Expiring") cls="yellow";
    list.innerHTML+=`
<tr class="${cls}">
<td>${p.project||""}</td>
<td>${p.unit||""}</td>
<td>${p.status||""}</td>
<td>${p.asking_rent||""}</td>
${role==="ADMIN"?`<td>${p.owner_name||""}</td><td>${p.owner_phone||""}</td>`:""}
<td>${p.notes||""}</td>
${role==="ADMIN"?`<td><button onclick='edit(${JSON.stringify(p)})'>Edit</button></td>`:""}
</tr>`;
  });
}

function edit(p){
  pid.value=p.id;
  project.value=p.project||"";
  unit.value=p.unit||"";
  status.value=p.status||"Vacant";
  rent.value=p.asking_rent||"";
  owner.value=p.owner_name||"";
  phone.value=p.owner_phone||"";
  notes.value=p.notes||"";
}

async function save(){
  const body={
    project:project.value,
    unit:unit.value,
    status:status.value,
    asking_rent:rent.value,
    owner_name:owner.value,
    owner_phone:phone.value,
    notes:notes.value
  };
  let method="POST";
  if(pid.value){ body.id=pid.value; method="PUT"; }
  await fetch("/api/properties",{
    method,
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify(body)
  });
  pid.value="";
  load();
}
</script>
</body>
</html>
