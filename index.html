<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Property Desk</title>
<style>
body{font-family:Arial,sans-serif;background:#f3f4f6;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;max-width:1000px;margin:auto;overflow-x:auto;}
input,select,button{padding:6px;margin:4px;box-sizing:border-box;}
table{width:100%;border-collapse:collapse;margin-top:20px;table-layout:auto;}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:left;vertical-align:top;white-space:normal;}
th{background:#f3f4f6;}
.green{background:#bbf7d0;}
.red{background:#fca5a5;}
.yellow{background:#fde68a;}
.admin-only{display:none;}
button{padding:4px 8px;cursor:pointer;}
</style>
</head>
<body>

<div class="card" id="login">
<h2>Login</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<div id="err" style="color:red;"></div>
</div>

<div class="card" id="app" style="display:none">
<h2>Properties</h2>

<div class="admin-only">
<h3>Add / Edit Property</h3>
<input id="pid" type="hidden">
<input id="project" placeholder="Project">
<input id="unit" placeholder="Unit">
<select id="status">
<option>Vacant</option>
<option>Rented</option>
</select>
<input id="rent" placeholder="Asking Rent">
<input id="owner" placeholder="Owner Name">
<input id="phone" placeholder="Owner Phone">
<input id="notes" placeholder="Notes">
<button onclick="save()">Save</button>
</div>

<table>
<thead>
<tr>
<th>Project</th>
<th>Unit</th>
<th>Status</th>
<th>Asking Rent</th>
<th class="admin-only">Owner</th>
<th>Notes</th>
<th class="admin-only">Edit</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<script>
let token="", role="";
const loginCard=document.getElementById("login");
const appCard=document.getElementById("app");
const errDiv=document.getElementById("err");
const list=document.getElementById("list");

// 缓存 properties
let propertiesCache = {};

async function login(){
  errDiv.innerText="";
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value;
  try{
    const res=await fetch("/api/login",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email,password})
    });
    const data=await res.json();
    if(!res.ok){ errDiv.innerText=data.error||"Login failed"; return; }
    token=data.token; role=data.role;
    loginCard.style.display="none"; appCard.style.display="block";
    if(role==="ADMIN") document.querySelectorAll(".admin-only").forEach(e=>e.style.display="block");
    await loadProperties();
  }catch(e){ errDiv.innerText="Cannot connect to server"; console.error(e); }
}

async function loadProperties(){
  const res=await fetch("/api/properties",{ headers:{ Authorization:"Bearer "+token }});
  const data=await res.json();
  list.innerHTML=""; propertiesCache={};
  data.properties.forEach(p=>{
    propertiesCache[p.id]=p;
    let cls="green"; if(p.status==="Rented") cls="red"; if(p.status==="Expiring") cls="yellow";

    let ownerText="";
    if(role==="ADMIN"){
      const name = p.owner_name||"";
      const phone = p.owner_phone||"";
      ownerText = `${name}${phone?'<br>'+phone:''}`;
    }

    list.innerHTML+=`
<tr class="${cls}" data-id="${p.id}">
<td>${p.project||""}</td>
<td>${p.unit||""}</td>
<td>${p.status||""}</td>
<td>${p.asking_rent||""}</td>
<td class="admin-only">${ownerText}</td>
<td>${p.notes||""}</td>
<td class="admin-only"><button onclick="editProperty(${p.id})">Edit</button></td>
</tr>`;
  });
}

function editProperty(id){
  const p=propertiesCache[id]; if(!p) return;
  document.getElementById("pid").value=p.id;
  document.getElementById("project").value=p.project||"";
  document.getElementById("unit").value=p.unit||"";
  document.getElementById("status").value=p.status||"Vacant";
  document.getElementById("rent").value=p.asking_rent||"";
  document.getElementById("owner").value=p.owner_name||"";
  document.getElementById("phone").value=p.owner_phone||"";
  document.getElementById("notes").value=p.notes||"";
}

async function save(){
  const body={
    project:document.getElementById("project").value,
    unit:document.getElementById("unit").value,
    status:document.getElementById("status").value,
    asking_rent:document.getElementById("rent").value,
    owner_name:document.getElementById("owner").value,
    owner_phone:document.getElementById("phone").value,
    notes:document.getElementById("notes").value
  };
  const pid=document.getElementById("pid").value;
  let method="POST";
  if(pid){ body.id=pid; method="PUT"; }
  await fetch("/api/properties",{
    method,
    headers:{"Content-Type":"application/json", Authorization:"Bearer "+token},
    body:JSON.stringify(body)
  });
  document.getElementById("pid").value="";
  await loadProperties();
}
</script>
</body>
</html>
